
	private _fnc_scriptNameParent = if (isNil '_fnc_scriptName') then {'BIS_fnc_OM_phone_core'} else {_fnc_scriptName};
	private _fnc_scriptName = 'BIS_fnc_OM_phone_core';
	scriptName _fnc_scriptName;

#line 1 "\A3\Missions_F_Oldman\Systems\scripts\Phone\fn_OM_phone_core.sqf [BIS_fnc_OM_phone_core]"
#line 1 "A3\Missions_F_Oldman\Systems\scripts\Phone\fn_OM_phone_core.sqf"
#line 1 "A3\Missions_F_Oldman\Systems\scripts\Phone\common_definitions.inc"



#line 1 "a3\Ui_f\hpp\defineResincl.inc"






















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































#line 4 "A3\Missions_F_Oldman\Systems\scripts\Phone\common_definitions.inc"

#line 1 "a3\Ui_f\hpp\defineCommonGrids.inc"















































































































































































































































































































































































































































































#line 5 "A3\Missions_F_Oldman\Systems\scripts\Phone\common_definitions.inc"
















































































































































#line 1 "A3\Missions_F_Oldman\Systems\scripts\Phone\fn_OM_phone_core.sqf"



_null = player createDiarySubject ["Phone", 						"Phone"];
_null = player createDiarySubject ["Contacts", 					"	• Contacts"];
_null = player createDiarySubject ["CallLog", 					"	• Call Log"];
_null = player createDiarySubject ["MakeaCall", 				"	• Make a Call"];
_null = player createDiarySubject ["Messages", 					"	• Messages"];
_null = player createDiarySubject ["Weather Forecast", 	"	• Weather Forecast"];
_null = player createDiarySubject ["Alarm", 						" • Alarm"];



BIS_OM_phone_section_contacts = player createDiaryRecord [ localize "STR_A3_OM_fn_OM_phone_core.sqf0", ["Contacts",  localize "STR_A3_OM_fn_OM_phone_core.sqf1"], taskNull, "", FALSE];
BIS_OM_phone_section_calls = player createDiaryRecord ["CallLog", [ localize "STR_A3_OM_fn_OM_phone_core.sqf2",  localize "STR_A3_OM_fn_OM_phone_core.sqf3"], taskNull, "", FALSE];
BIS_OM_phone_section_call = player createDiaryRecord ["MakeaCall", [ localize "STR_A3_OM_fn_OM_phone_core.sqf4",  localize "STR_A3_OM_fn_OM_phone_core.sqf5"], taskNull, "", FALSE];
BIS_OM_phone_section_sms = player createDiaryRecord [ localize "STR_A3_OM_fn_OM_phone_core.sqf6", ["Messages",  localize "STR_A3_OM_fn_OM_phone_core.sqf7"], taskNull, "", FALSE];
BIS_OM_phone_section_weather = player createDiaryRecord [ localize "STR_A3_OM_fn_OM_phone_core.sqf8", ["Weather Forecast", "<br/><br/><br/><br/><br/><br/><br/><br/><br/>"], taskNull, "", FALSE];




BIS_OM_messageReceivedTime = -10;
BIS_OM_messagesPool = [];
BIS_OM_callsPool = [];
BIS_OM_callID = 1;
BIS_OM_incomingCallsPool = [];
BIS_OM_contactsPool = [];
BIS_OM_unreadMessagesCnt = 0;
BIS_OM_PhoneUIID = 4;
BIS_OM_trackerEnabled = TRUE;
BIS_OM_hideAlarmIconTime = -1;
BIS_OM_enemiesNearby = FALSE;



BIS_fnc_OM_phone_getButtonText =
{
params["_buttonKey"];
private _ctrlTextIndex = floor ((((missionNameSpace getVariable ["BIS_OM_PhoneMenuBox", []] findIf {_x select 0 == _buttonKey}))+4)/4);
(findDisplay 12 displayCtrl 									6111) ctHeaderControls (_ctrlTextIndex - 1) select ((((missionNameSpace getVariable ["BIS_OM_PhoneMenuBox", []] findIf {_x select 0 == _buttonKey})) % 4) + 4)
};
BIS_fnc_OM_phone_getButton =
{
params["_buttonKey"];
private _ctrlTextIndex = floor ((((missionNameSpace getVariable ["BIS_OM_PhoneMenuBox", []] findIf {_x select 0 == _buttonKey}))+4)/4);
(findDisplay 12 displayCtrl 									6111) ctHeaderControls (_ctrlTextIndex - 1) select (((missionNameSpace getVariable ["BIS_OM_PhoneMenuBox", []] findIf {_x select 0 == _buttonKey})) % 4)
};

BIS_fnc_OM_phone_enableButton =
{
params["_buttonKey", ["_enable", true, [true]] ];
private _ctrlButton = [_buttonKey] call BIS_fnc_OM_phone_getButton;
private _ctrlButtonText = [_buttonKey] call BIS_fnc_OM_phone_getButtonText;
private _sourceIndex = (missionNameSpace getVariable ["BIS_OM_PhoneMenuBox", []] findIf {_x select 0 == _buttonKey});
{
if (_enable) then
{
_x ctrlEnable true;
_x ctrlShow true;
_x ctrlSetFade 0.0;
_x ctrlCommit 1;
((missionNameSpace getVariable "BIS_OM_PhoneMenuBox") select _sourceIndex) set [		6, true];
}
else
{
_x ctrlEnable false;
_x ctrlShow false;
_x ctrlSetFade 1.0;
_x ctrlCommit 1;
((missionNameSpace getVariable "BIS_OM_PhoneMenuBox") select _sourceIndex) set [		6, false];
};
} forEach [_ctrlButton, _ctrlButtonText];

};

BIS_fnc_OM_phone_detectorToggle = {
scriptName "BIS_fnc_OM_phone_detectorToggle";
params["_detectorButton"];

private _ctrlButtonText = ["DETECTOR"] call BIS_fnc_OM_phone_getButtonText;
if (BIS_OM_trackerEnabled) then {

_detectorButton ctrlSetFade 0.5;
_detectorButton ctrlCommit 0;
_ctrlButtonText ctrlSetStructuredText parsetext format ["<t font='RobotoCondensed' shadow='0' color='#b6bf81' size='0.58	' align='center'>%1</t>", localize "str_a3_geofinder_off"];	
BIS_OM_trackerEnabled = FALSE;
playSound "hint";


} else {

_detectorButton ctrlSetFade 0.0;
_ctrlButtonText ctrlSetStructuredText parsetext format ["<t font='RobotoCondensed' shadow='0' color='#b6bf81' size='0.58	' align='center'>%1</t>", localize "str_a3_geofinder_on"];	
BIS_OM_trackerEnabled = TRUE;
playSound "hint";


};
_detectorButton ctrlCommit 0;
_ctrlButtonText ctrlCommit 0;
};

BIS_fnc_OM_phone_correct_time =
{
params [ ["_dateToFix", date, [[]] ] ];

private _min = _dateToFix#4;
if (_dateToFix#4 == 0) then {_min = parseText "00"} else { 
if (_dateToFix#4 < 10) then {_min = parseText ("0" + str (date#4))}; 
};
_fixedDate = [_dateToFix#0,_dateToFix#1,_dateToFix#2,_dateToFix#3,_min];

_fixedDate
};

[] spawn {
scriptName "phoneCore/AlarmForecastMessages";
waitUntil {sleep 0.1; !isNull (findDisplay 12 displayCtrl 1001)};
BIS_OM_AlarmUIID = -1;
BIS_OM_ForecastUIID = -1;
BIS_OM_MessagesUIID = -1;
_listCnt = 0;
while {TRUE} do {
waitUntil {sleep 1; _listCnt != lbSize (findDisplay 12 displayCtrl 1001)};
_listCnt = lbSize (findDisplay 12 displayCtrl 1001);
for [{_i = 0}, {_i < _listCnt}, {_i = _i + 1}] do {
if (((findDisplay 12 displayCtrl 1001) lbText _i) == "	• Alarm") then {
BIS_OM_AlarmUIID = _i;
};
if (((findDisplay 12 displayCtrl 1001) lbText _i) == "	• Weather Forecast") then {
BIS_OM_ForecastUIID = _i;
};
if ((((findDisplay 12 displayCtrl 1001) lbText _i) find "	• Messages") != -1) then {
BIS_OM_MessagesUIID = _i;
};
};
};
};

[] spawn {
scriptName "phoneCore/ForecastUIID";
waitUntil {sleep 0.1; !isNull (findDisplay 12 displayCtrl 9999012)};
waitUntil {!isNil "BIS_OM_ForecastUIID"};
while {TRUE} do {
waitUntil {lbCurSel (findDisplay 12 displayctrl 1001) != BIS_OM_ForecastUIID};
for [{_i = 9999000}, {_i <= 9999012}, {_i = _i + 1}] do {
(findDisplay 12 displayCtrl _i) ctrlShow FALSE;
};
waitUntil {sleep 0.1; lbCurSel (findDisplay 12 displayctrl 1001) == BIS_OM_ForecastUIID};
for [{_i = 9999000}, {_i <= 9999012}, {_i = _i + 1}] do {
(findDisplay 12 displayCtrl _i) ctrlShow TRUE;
};
};
};

[] spawn {
BIS_OM_restCheckTrigger = createTrigger ["EmptyDetector", position player];
BIS_OM_restCheckTrigger attachTo [player, [0, 0, 0]];
player addEventHandler ["GetInMan", {detach BIS_OM_restCheckTrigger; BIS_OM_restCheckTrigger attachTo [vehicle player, [0, 0, 0]]}];
player addEventHandler ["GetOutMan", {detach BIS_OM_restCheckTrigger; BIS_OM_restCheckTrigger attachTo [player, [0, 0, 0]]}];
BIS_OM_restCheckTrigger setTriggerArea [150, 150, 0, FALSE];
BIS_OM_restCheckTrigger setTriggerActivation ["EAST", "PRESENT", TRUE];






BIS_OM_restCheckTriggerActivationCode =
{
private _alarmButton = ((findDisplay 12) getVariable 						"diaryInit_ctrlMenuBottomAlarm");
BIS_OM_enemiesNearby = TRUE;
_alarmButton ctrlSetFade 0.45;
_alarmButton ctrlCommit 0;
};
BIS_OM_restCheckTriggerDeactivationCode =
{
private _alarmButton = ((findDisplay 12) getVariable 						"diaryInit_ctrlMenuBottomAlarm");
BIS_OM_enemiesNearby = FALSE;
_alarmButton ctrlSetFade 0.0;
_alarmButton ctrlCommit 0;
};
BIS_OM_restCheckTriggerAlarmCode = {player setVariable ["BIS_IsWaiting", TRUE]; _null = [] execVM "\a3\Missions_F_Oldman\Systems\UI\Sleeping\Createrestui.SQF"};
BIS_OM_restCheckTrigger setTriggerStatements [
"this",
"_null = [] call BIS_OM_restCheckTriggerActivationCode",
"_null = [] call BIS_OM_restCheckTriggerDeactivationCode"
];
};

[] spawn {
waitUntil {!isNull findDisplay 46};
uiNamespace setVariable ["BIS_OM_phoneIconSMS", (findDisplay 46) ctrlCreate ["RscPictureKeepAspect", 9999013]];
uiNamespace setVariable ["BIS_OM_phoneIconAlarm", (findDisplay 46) ctrlCreate ["RscPictureKeepAspect", 9999015]];
uiNamespace setVariable ["BIS_OM_phoneIconRest", (findDisplay 46) ctrlCreate ["RscPictureKeepAspect", 9999016]];
_phoneIconSMS = uiNamespace getVariable "BIS_OM_phoneIconSMS";
_phoneIconAlarm = uiNamespace getVariable "BIS_OM_phoneIconAlarm";
_phoneIconRest = uiNamespace getVariable "BIS_OM_phoneIconRest";
_ratio = getResolution # 4;
_phoneIconSMS ctrlSetPosition [safeZoneX, safeZoneY + 0.3, (safeZoneW / 40), (safeZoneH / 40) * _ratio];
_phoneIconAlarm ctrlSetPosition [safeZoneX, safeZoneY + 0.35, (safeZoneW / 40), (safeZoneH / 40) * _ratio];
_phoneIconRest ctrlSetPosition [safeZoneX, safeZoneY + 0.4, (safeZoneW / 40), (safeZoneH / 40) * _ratio];
{_x ctrlCommit 0; _x ctrlShow FALSE} forEach [_phoneIconSMS, _phoneIconAlarm, _phoneIconRest];
_phoneIconSMS ctrlSetText "\a3\Missions_F_Oldman\Data\img\PhoneCore\newsms.pac";
_phoneIconAlarm ctrlSetText "\a3\Missions_F_Oldman\Data\img\PhoneCore\newmap.pac";
_phoneIconRest ctrlSetText "\a3\Missions_F_Oldman\Data\img\PhoneCore\timeskipPhone.pac";








 
};

[] spawn {
scriptName "phoneCore/hideAlarmIconTime0";
waitUntil {!isNil "BIS_OM_AlarmUIID"};
while {TRUE} do {
waitUntil {sleep 0.25; BIS_OM_enemiesNearby && visibleMap && lbCurSel (findDisplay 12 displayctrl 1001) == BIS_OM_AlarmUIID};
while {visibleMap && lbCurSel (findDisplay 12 displayctrl 1001) == BIS_OM_AlarmUIID} do {
BIS_OM_hideAlarmIconTime = time + 20;
sleep 1;
};
};
};

[] spawn {
scriptName "phoneCore/hideAlarmIconTime1";
waitUntil {!isNil "BIS_OM_AlarmUIID"};
while {TRUE} do {
sleep 1;
if (!BIS_OM_enemiesNearby && visibleMap && lbCurSel (findDisplay 12 displayctrl 1001) == BIS_OM_AlarmUIID) then {
BIS_OM_hideAlarmIconTime = time;
};
};
};

[] spawn {
scriptName "phoneCore/hideAlarmIconTime2";
while {TRUE} do {
waitUntil {sleep 1; BIS_OM_hideAlarmIconTime > time};
(findDisplay 46 displayCtrl 9999016) ctrlShow TRUE;
while {BIS_OM_hideAlarmIconTime > time} do {
(findDisplay 46 displayCtrl 9999016) ctrlSetTextColor (if (BIS_OM_enemiesNearby) then {[1, 1, 1, 0.35]} else {[1, 1, 1, 1]});
sleep 1;
};
(findDisplay 46 displayCtrl 9999016) ctrlShow FALSE;
};
};

[] spawn
{
scriptName "phoneCore/timeAndAccount";
uiNameSpace setVariable ["BIS_DiaryItems", lbSize ((findDisplay 12) displayCtrl 1001)];
while {TRUE} do
{
sleep 2;
if( visibleMap ) then
{
((findDisplay 12) getVariable 								"diaryInit_ctrlMenuTopClockText") ctrlSetStructuredText parseText format [	"<t font='LCD14' color='#819651' size='2.5' align='center'>%1</t><br/><t font='PuristaLight' color='#90a269' size='0.9' align='center'>%2</t>",	[daytime,"HH:MM"] call bis_fnc_timeToString, 	format ["%1.%2.%3", date select 2,date select 1,date select 0] ];
((findDisplay 12) getVariable 								"diaryInit_ctrlMenuTopBottomBarGroup") ctrlSetStructuredText parseText format [ 	"<t font='PuristaLight' color='#90a269' size='1.1' align='center'>%1 $</t>", 	if(!isNil "BIS_fnc_OM_moduleEconomy") then {[3,[]] call BIS_fnc_OM_moduleEconomy} else {"0"} ];
if( uiNameSpace getVariable ["BIS_DiaryItems",0] != lbSize ((findDisplay 12) displayCtrl 1001) ) then
{
[] call BIS_fnc_OM_phone_menuInit;
uiNameSpace setVariable ["BIS_DiaryItems", lbSize ((findDisplay 12) displayCtrl 1001)];
};
};
}
};

addMissionEventHandler ["Map", 
{
params ["_mapIsOpened", "_mapIsForced"];

if (BIS_OM_messageReceivedTime >= (time - 5)) then 
{
if (_mapIsOpened) then { BIS_OM_messageReceivedTime = -10 };
};

if (_mapIsOpened) then 
{
if (BIS_OM_unreadMessagesCnt > 0) then 
{
[] spawn 
{ 
isNil
{
if (BIS_OM_unreadMessagesCnt > 0 && visibleMap) then
{
processDiaryLink "<log subject=""Map""></log>";
processDiaryLink "<log subject=""Messages""></log>";
};
};
};
};
};

findDisplay 46 displayCtrl 9999013 ctrlShow (!_mapIsOpened && BIS_OM_unreadMessagesCnt > 0); 
}];

